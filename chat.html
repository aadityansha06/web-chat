<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat (Tailwind)</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; margin: 6px 0; }
    .me { margin-left: auto; background: linear-gradient(90deg,#3a7afe,#1f5fe0); color: white; }
    .them { margin-right: auto; background: #2b2b2b; color: #e5e7eb; }
  </style>
</head>
<body class="bg-gray-900 min-h-screen flex items-center justify-center text-gray-100">
  <div class="w-full max-w-md bg-gray-800 rounded-xl shadow-xl p-4">
    <h2 class="text-center text-xl font-semibold mb-3">ðŸ’¬ Chat Room</h2>

    <div id="messages" class="h-80 overflow-auto p-3 rounded bg-gray-900 border border-gray-700"></div>

    <div class="mt-3 flex gap-2">
      <input id="msg" class="flex-1 rounded px-3 py-2 bg-gray-800 border border-gray-700 focus:outline-none" placeholder="Type a message..." />
      <button id="sendBtn" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500">Send</button>
    </div>

    <p id="status" class="text-xs text-gray-400 mt-2">Status: idle</p>
  </div>

  <script>
    // â­ Each browser tab gets a unique ID
    const CLIENT_ID = crypto.randomUUID();
    console.log("Your Client ID =", CLIENT_ID);

    const SEND_URL = 'http://127.0.0.1:8080/send';
    const RECV_URL = 'http://127.0.0.1:8080/receive';
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('msg');
    const statusEl = document.getElementById('status');
    const sendBtn = document.getElementById('sendBtn');

    function showMessage(text, who = 'them') {
      const div = document.createElement('div');
      div.className = 'bubble ' + (who === 'me' ? 'me text-right' : 'them text-left');
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // SEND message
    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;

      showMessage(`You: ${text}`, 'me');
      inputEl.value = '';
      statusEl.textContent = 'Status: sending...';

      try {
        const res = await fetch(SEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `message=${encodeURIComponent(text)}&client_id=${encodeURIComponent(CLIENT_ID)}`
        });

        if (!res.ok) {
          statusEl.textContent = 'Status: send failed (' + res.status + ')';
        } else {
          statusEl.textContent = 'Status: sent';
        }

      } catch (err) {
        console.error("Send error:", err);
        statusEl.textContent = 'Status: network error';
      }
    }

    // RECEIVE messages
    async function receiveMessages() {
      try {
        const res = await fetch(`${RECV_URL}?client_id=${CLIENT_ID}`, {
          method: 'GET'
        });

        if (!res.ok) return;

        const text = await res.text();

        if (text.trim() !== '') {
          text.split("\n").forEach(line => {
            if (line.trim() !== "")
              showMessage(line, 'them');
          });
        }

      } catch (err) {
        console.error("Receive error:", err);
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    setInterval(receiveMessages, 1000);

    inputEl.focus();
  </script>

</body>
</html>
